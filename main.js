/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var u=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var D=Object.prototype.hasOwnProperty;var A=(n,s)=>{for(var e in s)u(n,e,{get:s[e],enumerable:!0})},$=(n,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let r of R(s))!D.call(n,r)&&r!==e&&u(n,r,{get:()=>s[r],enumerable:!(t=S(s,r))||t.enumerable});return n};var B=n=>$(u({},"__esModule",{value:!0}),n);var N={};A(N,{default:()=>h});module.exports=B(N);var k=require("obsidian");var g={enableHtmlParsing:!0};var H=()=>(n,s="unknown")=>{console.debug(`[CardViewer] Error in ${s}:`,n.message)},T=async(n,s,e="unknown")=>{try{return await n()}catch(t){return s(t,e),null}};var v=class{parseCard(s,e){let t=i=>{let o=e.split(`
`);for(let c of o){let d=c.match(new RegExp(`^${i}:\\s*(.*)$`));if(d){let C=d[1].trim();return C.length>0?C:void 0}}},r=i=>{let o=t(i);return o?parseFloat(o):void 0},a=t("title");return{type:s||"unknown",title:a||"\u672A\u547D\u540D",id:t("id")||r("id"),release_date:t("release_date"),region:t("region"),rating:r("rating"),runtime:r("runtime"),genres:t("genres"),overview:t("overview"),poster:t("poster"),author:t("author"),album:t("album"),duration:r("duration"),url:t("url"),source:t("source"),external_url:t("external_url")}}},x=new v;var M=require("obsidian"),E=class{constructor(s){this.app=s}processImagePath(s){let e=s;try{e=decodeURIComponent(e)}catch(t){}if(e.startsWith("./")){let t=e.replace(/^\.\//,"");return this.getVaultResourcePath(t)||s}else if(e.startsWith("../")){let t=e.replace(/^\.\.\//,"");return this.getVaultResourcePath(t)||s}else if(e.startsWith("/")&&!e.startsWith("//")){let t=e.substring(1);return this.getVaultResourcePath(t)||s}else if(!e.startsWith("/")&&!e.startsWith("http://")&&!e.startsWith("https://")&&!e.startsWith("data:")&&!e.startsWith("blob:")&&!e.startsWith("file:"))return this.getVaultResourcePath(e)||s;return e}getVaultResourcePath(s){try{let e=this.app.vault.getAbstractFileByPath(s);if(e instanceof M.TFile)return this.app.vault.getResourcePath(e)}catch(e){console.warn(`Failed to get resource path for: ${s}`,e)}return null}};function m(n){return new E(n)}var f=class{constructor(s){this.app=s;this.imagePathProcessor=m(s)}async renderCard(s,e,t,r){if(!t||typeof t.createEl!="function")return;let a=x.parseCard(s,e);if(!a){t.createEl("div",{text:"Invalid card format"});return}let i=t.createEl("div",{cls:"card-viewer-card"}),o=i.createEl("div",{cls:"card-viewer-content"}),c=o.createEl("div",{cls:"card-viewer-poster-section"}),d=o.createEl("div",{cls:"card-viewer-info-section"});this.addCardClickHandler(i,a),this.renderCardHeader(d,a),this.renderRating(d,a),this.renderDetails(d,a),this.renderPoster(c,a),this.renderAdditionalInfo(d,a)}addCardClickHandler(s,e){(e.id||e.type==="music"&&e.url||e.external_url)&&(s.addClass("card-viewer-clickable"),s.addEventListener("click",t=>{if(t.preventDefault(),e.external_url){window.open(e.external_url,"_blank");return}if(e.type==="music"&&e.url)window.open(e.url,"_blank");else if(e.id){let r=this.getBaseUrl(e);window.open(`${r}${e.id}`,"_blank")}}))}getBaseUrl(s){return s.source==="douban"?s.type==="movie"||s.type==="tv"?"https://movie.douban.com/subject/":s.type==="book"?"https://book.douban.com/subject/":"https://movie.douban.com/subject/":s.type==="tv"?"https://www.themoviedb.org/tv/":s.type==="book"?"https://book.douban.com/subject/":"https://www.themoviedb.org/movie/"}renderCardHeader(s,e){let t=s.createEl("div",{cls:"card-viewer-header"}),r=t.createEl("h3",{text:e.title,cls:"card-viewer-title"});t.createEl("div",{cls:"card-viewer-header-right"}).createEl("span",{text:e.type.toUpperCase(),cls:`card-viewer-type card-viewer-type-${e.type}`})}renderRating(s,e){if(e.rating){let r=s.createEl("div",{cls:"card-viewer-meta"}).createEl("div",{cls:"card-viewer-rating"}),a=r.createEl("div",{cls:"card-viewer-stars"});this.renderStars(a,e.rating),r.createSpan({text:e.rating.toFixed(1),cls:"card-viewer-rating-text"})}}renderStars(s,e){let t=e/2;for(let r=0;r<5;r++){let a=r<Math.floor(t),i=r===Math.floor(t)&&t%1>=.5,o=s.createEl("span",{cls:`card-viewer-star ${a?"full":i?"half":"empty"}`});i?o.innerHTML=`<svg viewBox="0 0 20 20" fill="none"><defs><clipPath id="half-star-${r}"><rect x="0" y="0" width="10" height="20"/></clipPath></defs><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" fill="#d1d5db"/><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" fill="#fbbf24" clip-path="url(#half-star-${r})"/></svg>`:o.innerHTML='<svg viewBox="0 0 20 20" fill="none"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>'}}renderDetails(s,e){let t=s.createEl("div",{cls:"card-viewer-details"});if(this.addDetail(t,"\u65E5\u671F",e.release_date),e.type==="music"){if(this.addDetail(t,"\u4F5C\u8005",e.author),this.addDetail(t,"\u4E13\u8F91",e.album),e.duration){let r=Math.floor(e.duration/60),a=e.duration%60;this.addDetail(t,"\u65F6\u957F",`${r}:${a.toString().padStart(2,"0")}`)}}else e.type==="book"?this.addDetail(t,"\u4F5C\u8005",e.author):(this.addDetail(t,"\u5730\u533A",e.region),e.runtime&&this.addDetail(t,"\u65F6\u957F",`${e.runtime}\u5206\u949F`))}renderPoster(s,e){if(e.poster){let t=this.imagePathProcessor.processImagePath(e.poster),r=s.createEl("div",{cls:"card-viewer-poster-container"}),a=r.createEl("img",{cls:"card-viewer-poster card-viewer-poster-image",attr:{src:t,alt:e.title||"\u6D77\u62A5\u56FE\u7247"}});a.onerror=()=>{a.addClass("card-viewer-poster-image hidden");let i=r.createEl("div",{cls:"card-viewer-poster-error"});i.createEl("div",{text:"\u{1F4F7}",cls:"card-viewer-error-icon"}),i.createEl("div",{text:"\u56FE\u7247\u52A0\u8F7D\u5931\u8D25",cls:"card-viewer-error-text"})},a.onload=()=>{a.addClass("loaded")}}else{let t=s.createEl("div",{cls:"card-viewer-poster-placeholder",text:"\u6682\u65E0\u56FE\u7247"})}}renderAdditionalInfo(s,e){let t=s.querySelector(".card-viewer-details");if(t&&(this.addDetail(t,"\u7C7B\u578B",e.genres,"genres"),e.overview)){let a=t.createEl("div",{cls:"card-viewer-overview"}).createEl("div",{text:e.overview,cls:"card-viewer-overview-text"})}}addDetail(s,e,t,r=""){if(t){let a=s.createEl("div",{cls:`card-viewer-detail ${r}`});if(a.createEl("span",{text:`${e}: `,cls:"card-viewer-label"}),r==="genres"){let i=a.createEl("div",{cls:"card-viewer-genres-container"});t.toString().split(",").map(c=>c.trim()).forEach(c=>{c&&i.createEl("span",{text:c,cls:"card-viewer-genre-tag"})})}else a.createSpan({text:t.toString(),cls:"card-viewer-value"})}}},b=n=>new f(n);var w=class{constructor(s){this.app=s;this.imagePathProcessor=m(s)}async renderImgsGrid(s,e,t){try{let r=e.appendChild(document.createElement("div"));r.className="imgs-grid-header";let a=r.appendChild(document.createElement("span"));a.textContent="IMAGES",a.className="imgs-grid-type";let i=e.appendChild(document.createElement("div"));i.className="imgs-grid";let o=this.parseImages(s);o.length===0?this.renderEmptyPlaceholder(i):this.renderImages(i,o)}catch(r){let a=e.appendChild(document.createElement("div"));a.textContent=`\u56FE\u7247\u7F51\u683C\u6E32\u67D3\u5931\u8D25: ${r.message}`}}parseImages(s){let e=/!\[([^\]]*)\]\(([^\s\)]+)(?:\s+"([^"]+)")?\)/g,t=[],r;for(;(r=e.exec(s))!==null;)t.push({alt:r[1]||"",src:r[2],title:r[3]||""});return t}renderEmptyPlaceholder(s){let e=s.appendChild(document.createElement("div"));e.className="imgs-grid-placeholder",e.textContent="\u672A\u627E\u5230\u56FE\u7247"}renderImages(s,e){e.forEach((t,r)=>{let a=this.createImageItem(t,r);s.appendChild(a)})}createImageItem(s,e){let t=document.createElement("div");t.className="imgs-grid-item";let r=this.processImageSrc(s.src),a=this.createImageElement(t,r,s);return s.title&&this.addImageTitle(t,s.title),this.setupErrorHandling(a,t),this.setupClickHandler(a,r,s),t}processImageSrc(s){return this.imagePathProcessor.processImagePath(s)}createImageElement(s,e,t){let r=s.appendChild(document.createElement("img"));return r.className="imgs-grid-image",r.src=e,r.alt=t.alt,r.loading="lazy",r}addImageTitle(s,e){let t=s.appendChild(document.createElement("div"));t.className="imgs-grid-title",t.textContent=e}setupErrorHandling(s,e){s.onerror=()=>{e.classList.add("error");let t=e.appendChild(document.createElement("div"));t.className="imgs-grid-error",t.textContent="\u56FE\u7247\u52A0\u8F7D\u5931\u8D25"}}setupClickHandler(s,e,t){s.addEventListener("click",()=>{this.showImageModal(e,t)})}showImageModal(s,e){let t=document.createElement("div");t.className="imgs-modal",t.innerHTML=`
      <div class="imgs-modal-content">
        <button class="imgs-modal-close" type="button" aria-label="\u5173\u95ED">&times;</button>
        <img src="${s}" alt="${e.alt}" class="imgs-modal-image">
        ${e.title?`<div class="imgs-modal-title">${e.title}</div>`:""}
      </div>
    `,document.body.appendChild(t);let r=()=>{document.body.removeChild(t)},a=t.querySelector(".imgs-modal-close");a&&a.addEventListener("click",r),t.addEventListener("click",i=>{i.target===t&&r()})}},L=n=>new w(n);var P=class{constructor(s){this.app=s;this.imagePathProcessor=m(s)}async renderHtml(s,e){try{s.empty(),s.addClass("html-viewer-content");let t=this.preprocessHtmlContent(e),r=document.createElement("div");r.innerHTML=t;let a=Array.from(r.children);for(let i of a)s.appendChild(i.cloneNode(!0));await this.postProcessHtmlElements(s)}catch(t){console.error("HTML\u6E32\u67D3\u5931\u8D25:",t);let r=t instanceof Error?t.message:String(t);this.showError(s,`HTML\u6E32\u67D3\u5931\u8D25: ${r}`)}}preprocessHtmlContent(s){return s=s.replace(/<img([^>]*?)src=["']([^"']*?)["']([^>]*?)>/gi,(e,t,r,a)=>{let i=this.imagePathProcessor.processImagePath(r);return`<img${t}src="${i}"${a}>`}),s=s.replace(/<media-player([^>]*?)>/gi,(e,t)=>(t=t.replace(/src=["']([^"']*?)["']/gi,(r,a)=>`src="${this.imagePathProcessor.processImagePath(a)}"`),t=t.replace(/poster=["']([^"']*?)["']/gi,(r,a)=>`poster="${this.imagePathProcessor.processImagePath(a)}"`),`<media-player${t}>`)),s}async postProcessHtmlElements(s){s.querySelectorAll("media-player").forEach(r=>{let a=setTimeout(()=>{r.hasAttribute("data-loaded")||(console.warn("Media player\u52A0\u8F7D\u8D85\u65F6"),this.showImageError(r,"\u5A92\u4F53\u52A0\u8F7D\u8D85\u65F6"))},1e4);r.addEventListener("loadeddata",()=>{clearTimeout(a),r.setAttribute("data-loaded","true")}),r.addEventListener("error",()=>{clearTimeout(a),this.showImageError(r,"\u5A92\u4F53\u52A0\u8F7D\u5931\u8D25")})}),s.querySelectorAll("img").forEach(r=>{r.addEventListener("error",()=>{this.showImageError(r,"\u56FE\u7247\u52A0\u8F7D\u5931\u8D25")}),r.addEventListener("load",()=>{r.setAttribute("data-loaded","true")})})}showError(s,e){s.empty();let t=s.createEl("div",{cls:"html-viewer-error",text:e})}showImageError(s,e){let t=document.createElement("div");t.className="image-load-error",t.textContent=e,s.parentNode&&s.parentNode.insertBefore(t,s.nextSibling)}};function I(n){return new P(n)}var l=require("obsidian"),y=class extends l.Modal{constructor(e,t,r,a,i,o){super(e);this.title=t,this.message=r,this.confirmText=a,this.cancelText=i,this.resolve=o}onOpen(){let{contentEl:e,titleEl:t}=this;t.setText(this.title),e.empty();let r=e.createEl("p");r.style.marginBottom="20px",r.style.lineHeight="1.5",r.setText(this.message);let a=e.createEl("div");a.style.display="flex",a.style.justifyContent="flex-end",a.style.gap="10px";let i=a.createEl("button");i.setText(this.cancelText),i.onclick=()=>{this.close(),this.resolve(!1)};let o=a.createEl("button");o.setText(this.confirmText),o.addClass("mod-cta"),o.onclick=()=>{this.close(),this.resolve(!0)}}onClose(){let{contentEl:e}=this;e.empty()}},p=class extends l.PluginSettingTab{constructor(e,t){super(e,t);this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Card Viewer \u8BBE\u7F6E"}),new l.Setting(e).setName("\u542F\u7528 HTML \u89E3\u6790").setDesc("\u662F\u5426\u542F\u7528 HTML \u4EE3\u7801\u5757\u7684\u89E3\u6790\u548C\u6E32\u67D3\u529F\u80FD").addToggle(t=>t.setValue(this.plugin.settings.enableHtmlParsing).onChange(async r=>{if(!r&&this.plugin.settings.enableHtmlParsing)if(await this.showConfirmDialog("\u786E\u8BA4\u7981\u7528 HTML \u89E3\u6790",`\u7981\u7528 HTML \u89E3\u6790\u529F\u80FD\u9700\u8981\u91CD\u542F\u63D2\u4EF6\u624D\u80FD\u5B8C\u5168\u751F\u6548\u3002

\u662F\u5426\u786E\u8BA4\u7981\u7528\u5E76\u7ACB\u5373\u91CD\u542F\u63D2\u4EF6\uFF1F`,"\u786E\u8BA4\u5E76\u91CD\u542F","\u53D6\u6D88"))this.plugin.settings.enableHtmlParsing=r,await this.plugin.saveSettings(),new l.Notice("HTML\u89E3\u6790\u5DF2\u7981\u7528\uFF0C\u6B63\u5728\u91CD\u542F\u63D2\u4EF6..."),await this.restartPlugin();else{t.setValue(!0);return}else this.plugin.settings.enableHtmlParsing=r,await this.plugin.saveSettings(),this.plugin.updateHtmlProcessor(),r&&new l.Notice("HTML\u89E3\u6790\u5DF2\u542F\u7528")}))}async showConfirmDialog(e,t,r,a){return new Promise(i=>{new y(this.app,e,t,r,a,i).open()})}async restartPlugin(){let e=this.plugin.manifest.id,t=this.app.plugins;try{await t.disablePlugin(e),await new Promise(r=>setTimeout(r,100)),await t.enablePlugin(e),setTimeout(()=>{try{t.plugins[e]?(this.app.setting.open(),this.app.setting.openTabById(e),new l.Notice("\u63D2\u4EF6\u91CD\u542F\u5B8C\u6210\uFF0C\u8BBE\u7F6E\u9875\u9762\u5DF2\u91CD\u65B0\u6253\u5F00")):new l.Notice("\u63D2\u4EF6\u91CD\u542F\u5B8C\u6210")}catch(r){console.error("Failed to reopen settings:",r),new l.Notice("\u63D2\u4EF6\u91CD\u542F\u5B8C\u6210")}},200)}catch(r){new l.Notice("\u63D2\u4EF6\u91CD\u542F\u5931\u8D25\uFF0C\u8BF7\u624B\u52A8\u91CD\u542F"),console.error("Plugin restart failed:",r)}}};var h=class extends k.Plugin{constructor(e,t){super(e,t);this.registeredEvents=[];this.htmlProcessorRegistered=!1;this.settings=g;this.registeredEvents=[],this.errorHandler=H()}async onload(){try{if(await this.loadSettings(),!this.validateApiCompatibility())return;this.initializeRenderers(),this.setupUserInterface(),await this.registerAllProcessors()}catch(e){this.errorHandler(e,"onload")}}onunload(){this.cleanup()}validateApiCompatibility(){var e;return(e=this.app)!=null&&e.workspace?typeof this.registerMarkdownCodeBlockProcessor!="function"?(console.warn("CardViewer: Code block processor API not available"),!1):!0:(console.warn("CardViewer: Workspace API not available"),!1)}initializeRenderers(){this.cardRenderer=b(this.app),this.imgsRenderer=L(this.app),this.htmlRenderer=I(this.app)}setupUserInterface(){this.addSettingTab(new p(this.app,this))}async registerAllProcessors(){let e=[{name:"Card Processors",fn:()=>this.registerCardProcessors()},{name:"HTML Processor",fn:()=>this.registerHtmlProcessor()},{name:"Post Processor",fn:()=>this.registerPostProcessor()}];for(let t of e)await T(t.fn,this.errorHandler,t.name)}registerCardProcessors(){["movie","tv","book","music"].forEach(t=>{this.registerMarkdownCodeBlockProcessor(`card-${t}`,this.createCardProcessor(t))})}createCardProcessor(e){return async(t,r,a)=>{try{await this.cardRenderer.renderCard(e,t,r,a)}catch(i){this.renderError(r,`\u6E32\u67D3${e}\u5361\u7247\u5931\u8D25`,i)}}}registerHtmlProcessor(){this.settings.enableHtmlParsing&&!this.htmlProcessorRegistered&&(this.registerMarkdownCodeBlockProcessor("html",this.createHtmlProcessor()),this.htmlProcessorRegistered=!0)}createHtmlProcessor(){return(e,t,r)=>{try{this.renderHtmlBlock(e,t)}catch(a){this.renderError(t,"HTML\u6E32\u67D3\u5931\u8D25",a)}}}updateHtmlProcessor(){var e;this.settings.enableHtmlParsing&&!this.htmlProcessorRegistered&&this.registerHtmlProcessor(),(e=this.app.workspace)==null||e.trigger("layout-change")}renderHtmlBlock(e,t){let r=e.trim(),a=this.createHtmlContainer(t),i=this.createContentArea(a);this.isEmptyHtmlContent(r)?this.renderEmptyContent(i):this.htmlRenderer.renderHtml(i,r)}createHtmlContainer(e){let t=e.createEl("div",{cls:"html-viewer-container"});return t.createEl("div",{cls:"html-viewer-header"}).createEl("span",{text:"HTML",cls:"html-viewer-type"}),t}createContentArea(e){return e.createEl("div",{cls:"html-viewer-content"})}renderEmptyContent(e){e.createEl("div",{cls:"html-viewer-placeholder",text:"\u7A7A\u7684HTML\u5185\u5BB9"})}isEmptyHtmlContent(e){return e.length===0?!0:[/^\s*<\w+(?:\s+(?!style|class|id)[^=]*(?:="[^"]*")?)*>\s*<\/\w+>\s*$/,/^\s*<\w+(?:\s+(?!style|class|id)[^=]*(?:="[^"]*")?)*\/>\s*$/].some(r=>r.test(e)&&!/\b(?:style|class|id)\s*=/.test(e))}registerPostProcessor(){this.registerMarkdownPostProcessor(async(e,t)=>{try{await Promise.all([this.processCardBlocks(e,t),this.processImgsBlocks(e,t)])}catch(r){console.warn("CardViewer: Post processor error:",r)}})}async processCardBlocks(e,t){let r=e.querySelectorAll('pre > code[class*="language-card"]');for(let a of Array.from(r)){let i=a,o=this.extractCardType(i.className);o&&await this.processCardBlock(i,o,t)}}extractCardType(e){let t=e.match(/language-card-([a-z]+)/);return t?t[1]:null}async processCardBlock(e,t,r){let a=e.textContent||"",i=e.parentElement;if(!(i!=null&&i.parentNode))return;let o=document.createElement("div");await this.cardRenderer.renderCard(t,a,o,r),i.parentNode.replaceChild(o,i)}async processImgsBlocks(e,t){let r=e.querySelectorAll('pre > code[class*="language-imgs"]');for(let a of Array.from(r))await this.processImgsBlock(a,t)}async processImgsBlock(e,t){let r=e.textContent||"",a=e.parentElement;if(!(a!=null&&a.parentNode))return;let i=document.createElement("div");i.className="imgs-grid-container",await this.imgsRenderer.renderImgsGrid(r,i,t),a.parentNode.replaceChild(i,a)}renderError(e,t,r){e&&typeof e.createEl=="function"&&e.createEl("div",{text:`${t}: ${r.message}`,cls:"card-viewer-error"})}cleanup(){try{this.htmlProcessorRegistered=!1,this.cleanupEventListeners()}catch(e){console.warn("CardViewer: Cleanup error:",e)}}cleanupEventListeners(){var e;(e=this.registeredEvents)!=null&&e.length&&(this.registeredEvents.forEach(t=>{var r;try{(r=t.detach)==null||r.call(t)}catch(a){}}),this.registeredEvents=[])}async loadSettings(){try{let e=await this.loadData();this.settings=Object.assign({},g,e)}catch(e){console.warn("CardViewer: Failed to load settings:",e),this.settings={...g}}}async saveSettings(){try{await this.saveData(this.settings)}catch(e){throw console.error("CardViewer: Failed to save settings:",e),e}}};
