/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var g=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var T=Object.getOwnPropertyNames;var L=Object.prototype.hasOwnProperty;var b=(l,r)=>{for(var e in r)g(l,e,{get:r[e],enumerable:!0})},k=(l,r,e,t)=>{if(r&&typeof r=="object"||typeof r=="function")for(let a of T(r))!L.call(l,a)&&a!==e&&g(l,a,{get:()=>r[a],enumerable:!(t=M(r,a))||t.enumerable});return l};var P=l=>k(g({},"__esModule",{value:!0}),l);var I={};b(I,{default:()=>p});module.exports=P(I);var x=require("obsidian");var w=()=>(l,r="unknown")=>{console.debug(`[CardViewer] Error in ${r}:`,l.message)},m=async(l,r,e="unknown")=>{try{return await l()}catch(t){return r(t,e),null}};var v=class{parseCard(r,e){let t=i=>{let n=e.split(`
`);for(let o of n){let c=o.match(new RegExp(`^${i}:\\s*(.*)$`));if(c){let d=c[1].trim();return d.length>0?d:void 0}}},a=i=>{let n=t(i);return n?parseFloat(n):void 0},s=t("title");return{type:r||"unknown",title:s||"\u672A\u547D\u540D",id:t("id")||a("id"),release_date:t("release_date"),region:t("region"),rating:a("rating"),runtime:a("runtime"),genres:t("genres"),overview:t("overview"),poster:t("poster"),author:t("author"),album:t("album"),duration:a("duration"),url:t("url"),source:t("source"),external_url:t("external_url")}}},C=new v;var h=class{constructor(r){this.app=r}async renderCard(r,e,t,a){if(!t||typeof t.createEl!="function")return;let s=C.parseCard(r,e);if(!s){t.createEl("div",{text:"Invalid card format"});return}let i=t.createEl("div",{cls:"card-viewer-card"}),n=i.createEl("div",{cls:"card-viewer-content"}),o=n.createEl("div",{cls:"card-viewer-poster-section"}),c=n.createEl("div",{cls:"card-viewer-info-section"});this.addCardClickHandler(i,s),this.renderCardHeader(c,s),this.renderRating(c,s),this.renderDetails(c,s),this.renderPoster(o,s),this.renderAdditionalInfo(c,s)}addCardClickHandler(r,e){(e.id||e.type==="music"&&e.url||e.external_url)&&(r.addClass("card-viewer-clickable"),r.addEventListener("click",t=>{if(t.preventDefault(),e.external_url){window.open(e.external_url,"_blank");return}if(e.type==="music"&&e.url)window.open(e.url,"_blank");else if(e.id){let a=this.getBaseUrl(e);window.open(`${a}${e.id}`,"_blank")}}))}getBaseUrl(r){return r.source==="douban"?r.type==="movie"||r.type==="tv"?"https://movie.douban.com/subject/":r.type==="book"?"https://book.douban.com/subject/":"https://movie.douban.com/subject/":r.type==="tv"?"https://www.themoviedb.org/tv/":r.type==="book"?"https://book.douban.com/subject/":"https://www.themoviedb.org/movie/"}renderCardHeader(r,e){let t=r.createEl("div",{cls:"card-viewer-header"}),a=t.createEl("h3",{text:e.title,cls:"card-viewer-title"});t.createEl("div",{cls:"card-viewer-header-right"}).createEl("span",{text:e.type.toUpperCase(),cls:`card-viewer-type card-viewer-type-${e.type}`})}renderRating(r,e){if(e.rating){let a=r.createEl("div",{cls:"card-viewer-meta"}).createEl("div",{cls:"card-viewer-rating"}),s=a.createEl("div",{cls:"card-viewer-stars"});this.renderStars(s,e.rating),a.createSpan({text:e.rating.toFixed(1),cls:"card-viewer-rating-text"})}}renderStars(r,e){let t=e/2;for(let a=0;a<5;a++){let s=a<Math.floor(t),i=a===Math.floor(t)&&t%1>=.5,n=r.createEl("span",{cls:`card-viewer-star ${s?"full":i?"half":"empty"}`});i?n.innerHTML=`<svg viewBox="0 0 20 20" fill="none"><defs><clipPath id="half-star-${a}"><rect x="0" y="0" width="10" height="20"/></clipPath></defs><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" fill="#d1d5db"/><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" fill="#fbbf24" clip-path="url(#half-star-${a})"/></svg>`:n.innerHTML='<svg viewBox="0 0 20 20" fill="none"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>'}}renderDetails(r,e){let t=r.createEl("div",{cls:"card-viewer-details"});if(this.addDetail(t,"\u65E5\u671F",e.release_date),e.type==="music"){if(this.addDetail(t,"\u4F5C\u8005",e.author),this.addDetail(t,"\u4E13\u8F91",e.album),e.duration){let a=Math.floor(e.duration/60),s=e.duration%60;this.addDetail(t,"\u65F6\u957F",`${a}:${s.toString().padStart(2,"0")}`)}}else e.type==="book"?this.addDetail(t,"\u4F5C\u8005",e.author):(this.addDetail(t,"\u5730\u533A",e.region),e.runtime&&this.addDetail(t,"\u65F6\u957F",`${e.runtime}\u5206\u949F`))}renderPoster(r,e){if(e.poster){let t=e.poster;if(t.startsWith("attachment/")&&this.app.vault.getAbstractFileByPath(t))try{t=this.app.vault.adapter.getResourcePath(t)}catch(n){}let a=r.createEl("div",{cls:"card-viewer-poster-container"}),s=a.createEl("img",{cls:"card-viewer-poster card-viewer-poster-image",attr:{src:t,alt:e.title||"\u6D77\u62A5\u56FE\u7247"}});s.onerror=()=>{s.addClass("card-viewer-poster-image hidden");let i=a.createEl("div",{cls:"card-viewer-poster-error"});i.createEl("div",{text:"\u{1F4F7}",cls:"card-viewer-error-icon"}),i.createEl("div",{text:"\u56FE\u7247\u52A0\u8F7D\u5931\u8D25",cls:"card-viewer-error-text"})},s.onload=()=>{s.addClass("loaded")}}else{let t=r.createEl("div",{cls:"card-viewer-poster-placeholder",text:"\u6682\u65E0\u56FE\u7247"})}}renderAdditionalInfo(r,e){let t=r.querySelector(".card-viewer-details");if(t&&(this.addDetail(t,"\u7C7B\u578B",e.genres,"genres"),e.overview)){let s=t.createEl("div",{cls:"card-viewer-overview"}).createEl("div",{text:e.overview,cls:"card-viewer-overview-text"})}}addDetail(r,e,t,a=""){if(t){let s=r.createEl("div",{cls:`card-viewer-detail ${a}`});if(s.createEl("span",{text:`${e}: `,cls:"card-viewer-label"}),a==="genres"){let i=s.createEl("div",{cls:"card-viewer-genres-container"});t.toString().split(",").map(o=>o.trim()).forEach(o=>{o&&i.createEl("span",{text:o,cls:"card-viewer-genre-tag"})})}else s.createSpan({text:t.toString(),cls:"card-viewer-value"})}}},y=l=>new h(l);var E=class{constructor(r){this.app=r}async renderImgsGrid(r,e,t){try{let a=e.appendChild(document.createElement("div"));a.className="imgs-grid-header";let s=a.appendChild(document.createElement("span"));s.textContent="IMAGES",s.className="imgs-grid-type";let i=e.appendChild(document.createElement("div"));i.className="imgs-grid";let n=this.parseImages(r);n.length===0?this.renderEmptyPlaceholder(i):this.renderImages(i,n)}catch(a){let s=e.appendChild(document.createElement("div"));s.textContent=`\u56FE\u7247\u7F51\u683C\u6E32\u67D3\u5931\u8D25: ${a.message}`}}parseImages(r){let e=/!\[([^\]]*)\]\(([^\s\)]+)(?:\s+"([^"]+)")?\)/g,t=[],a;for(;(a=e.exec(r))!==null;)t.push({alt:a[1]||"",src:a[2],title:a[3]||""});return t}renderEmptyPlaceholder(r){let e=r.appendChild(document.createElement("div"));e.className="imgs-grid-placeholder",e.textContent="\u672A\u627E\u5230\u56FE\u7247"}renderImages(r,e){e.forEach((t,a)=>{let s=this.createImageItem(t,a);r.appendChild(s)})}createImageItem(r,e){let t=document.createElement("div");t.className="imgs-grid-item";let a=this.processImageSrc(r.src),s=this.createImageElement(t,a,r);return r.title&&this.addImageTitle(t,r.title),this.setupErrorHandling(s,t),this.setupClickHandler(s,a,r),t}processImageSrc(r){let e=r;try{e=decodeURIComponent(e)}catch(t){}if(e.startsWith("../")&&(e=e.replace(/^\.\.\//,""),this.app.vault.getAbstractFileByPath(e)))try{e=this.app.vault.adapter.getResourcePath(e)}catch(a){}return e}createImageElement(r,e,t){let a=r.appendChild(document.createElement("img"));return a.className="imgs-grid-image",a.src=e,a.alt=t.alt,a.loading="lazy",a}addImageTitle(r,e){let t=r.appendChild(document.createElement("div"));t.className="imgs-grid-title",t.textContent=e}setupErrorHandling(r,e){r.onerror=()=>{e.classList.add("error");let t=e.appendChild(document.createElement("div"));t.className="imgs-grid-error",t.textContent="\u56FE\u7247\u52A0\u8F7D\u5931\u8D25"}}setupClickHandler(r,e,t){r.addEventListener("click",()=>{this.showImageModal(e,t)})}showImageModal(r,e){let t=document.createElement("div");t.className="imgs-modal",t.innerHTML=`
      <div class="imgs-modal-content">
        <button class="imgs-modal-close" type="button" aria-label="\u5173\u95ED">&times;</button>
        <img src="${r}" alt="${e.alt}" class="imgs-modal-image">
        ${e.title?`<div class="imgs-modal-title">${e.title}</div>`:""}
      </div>
    `,document.body.appendChild(t);let a=()=>{document.body.removeChild(t)},s=t.querySelector(".imgs-modal-close");s&&s.addEventListener("click",a),t.addEventListener("click",i=>{i.target===t&&a()})}},H=l=>new E(l);var p=class extends x.Plugin{constructor(e,t){super(e,t);this.registeredEvents=[];this.registeredEvents=[],this.errorHandler=w()}async onload(){!this.app||!this.app.workspace||typeof this.registerMarkdownCodeBlockProcessor=="function"&&(this.cardRenderer=y(this.app),this.imgsRenderer=H(this.app),await m(()=>this.registerCardProcessors(),this.errorHandler,"registerCardProcessors"),await m(()=>this.registerHtmlProcessor(),this.errorHandler,"registerHtmlProcessor"),await m(()=>this.registerPostProcessor(),this.errorHandler,"registerPostProcessor"))}onunload(){try{this.registeredEvents&&(this.registeredEvents.forEach(e=>{try{e.detach()}catch(t){}}),this.registeredEvents=[])}catch(e){}}registerCardProcessors(){["movie","tv","book","music"].forEach(t=>{this.registerMarkdownCodeBlockProcessor(`card-${t}`,async(a,s,i)=>{try{await this.cardRenderer.renderCard(t,a,s,i)}catch(n){s&&typeof s.createEl=="function"&&s.createEl("div",{text:`\u6E32\u67D3${t}\u5361\u7247\u5931\u8D25: ${n.message}`})}})})}registerHtmlProcessor(){this.registerMarkdownCodeBlockProcessor("html",(e,t,a)=>{try{this.renderHtmlBlock(e,t)}catch(s){t.createEl("div",{text:`HTML\u6E32\u67D3\u5931\u8D25: ${s.message}`})}})}renderHtmlBlock(e,t){let a=t.createEl("div",{cls:"html-viewer-container"});a.createEl("div",{cls:"html-viewer-header"}).createEl("span",{text:"HTML",cls:"html-viewer-type"});let i=a.createEl("div",{cls:"html-viewer-content"}),n=e.trim();this.isEmptyHtmlContent(n)?i.createEl("div",{cls:"html-viewer-placeholder",text:"\u7A7A\u7684HTML\u5185\u5BB9"}):i.innerHTML=e}isEmptyHtmlContent(e){return e.length===0||/^\s*<\w+(?:\s+(?!style|class|id)[^=]*(?:="[^"]*")?)*>\s*<\/\w+>\s*$/.test(e)&&!/\b(?:style|class|id)\s*=/.test(e)||/^\s*<\w+(?:\s+(?!style|class|id)[^=]*(?:="[^"]*")?)*\/>\s*$/.test(e)&&!/\b(?:style|class|id)\s*=/.test(e)}registerPostProcessor(){this.registerMarkdownPostProcessor(async(e,t)=>{try{await this.processCardBlocks(e,t),await this.processImgsBlocks(e,t)}catch(a){}})}async processCardBlocks(e,t){let a=e.querySelectorAll('pre > code[class*="language-card"]');for(let s=0;s<a.length;s++){let i=a[s],n=i.textContent||"",o=i.parentElement,c=null,d=i.className,u=d.match(/language-card-([a-z]+)/);if(u)c=u[1];else if(d.includes("language-card"))continue;let f=document.createElement("div");await this.cardRenderer.renderCard(c,n,f,t),o&&o.parentNode&&o.parentNode.replaceChild(f,o)}}async processImgsBlocks(e,t){let a=e.querySelectorAll('pre > code[class*="language-imgs"]');for(let s=0;s<a.length;s++){let i=a[s],n=i.textContent||"",o=i.parentElement,c=document.createElement("div");c.className="imgs-grid-container",await this.imgsRenderer.renderImgsGrid(n,c,t),o&&o.parentNode&&o.parentNode.replaceChild(c,o)}}};
