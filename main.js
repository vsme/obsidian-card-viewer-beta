/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var v=Object.defineProperty;var L=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var I=Object.prototype.hasOwnProperty;var D=(o,s)=>{for(var e in s)v(o,e,{get:s[e],enumerable:!0})},S=(o,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let r of k(s))!I.call(o,r)&&r!==e&&v(o,r,{get:()=>s[r],enumerable:!(t=L(s,r))||t.enumerable});return o};var R=o=>S(v({},"__esModule",{value:!0}),o);var $={};D($,{default:()=>h});module.exports=R($);var M=require("obsidian");var u={enableHtmlParsing:!0};var H=()=>(o,s="unknown")=>{console.debug(`[CardViewer] Error in ${s}:`,o.message)},p=async(o,s,e="unknown")=>{try{return await o()}catch(t){return s(t,e),null}};var E=class{parseCard(s,e){let t=a=>{let n=e.split(`
`);for(let l of n){let c=l.match(new RegExp(`^${a}:\\s*(.*)$`));if(c){let m=c[1].trim();return m.length>0?m:void 0}}},r=a=>{let n=t(a);return n?parseFloat(n):void 0},i=t("title");return{type:s||"unknown",title:i||"\u672A\u547D\u540D",id:t("id")||r("id"),release_date:t("release_date"),region:t("region"),rating:r("rating"),runtime:r("runtime"),genres:t("genres"),overview:t("overview"),poster:t("poster"),author:t("author"),album:t("album"),duration:r("duration"),url:t("url"),source:t("source"),external_url:t("external_url")}}},T=new E;var f=class{constructor(s){this.app=s}async renderCard(s,e,t,r){if(!t||typeof t.createEl!="function")return;let i=T.parseCard(s,e);if(!i){t.createEl("div",{text:"Invalid card format"});return}let a=t.createEl("div",{cls:"card-viewer-card"}),n=a.createEl("div",{cls:"card-viewer-content"}),l=n.createEl("div",{cls:"card-viewer-poster-section"}),c=n.createEl("div",{cls:"card-viewer-info-section"});this.addCardClickHandler(a,i),this.renderCardHeader(c,i),this.renderRating(c,i),this.renderDetails(c,i),this.renderPoster(l,i),this.renderAdditionalInfo(c,i)}addCardClickHandler(s,e){(e.id||e.type==="music"&&e.url||e.external_url)&&(s.addClass("card-viewer-clickable"),s.addEventListener("click",t=>{if(t.preventDefault(),e.external_url){window.open(e.external_url,"_blank");return}if(e.type==="music"&&e.url)window.open(e.url,"_blank");else if(e.id){let r=this.getBaseUrl(e);window.open(`${r}${e.id}`,"_blank")}}))}getBaseUrl(s){return s.source==="douban"?s.type==="movie"||s.type==="tv"?"https://movie.douban.com/subject/":s.type==="book"?"https://book.douban.com/subject/":"https://movie.douban.com/subject/":s.type==="tv"?"https://www.themoviedb.org/tv/":s.type==="book"?"https://book.douban.com/subject/":"https://www.themoviedb.org/movie/"}renderCardHeader(s,e){let t=s.createEl("div",{cls:"card-viewer-header"}),r=t.createEl("h3",{text:e.title,cls:"card-viewer-title"});t.createEl("div",{cls:"card-viewer-header-right"}).createEl("span",{text:e.type.toUpperCase(),cls:`card-viewer-type card-viewer-type-${e.type}`})}renderRating(s,e){if(e.rating){let r=s.createEl("div",{cls:"card-viewer-meta"}).createEl("div",{cls:"card-viewer-rating"}),i=r.createEl("div",{cls:"card-viewer-stars"});this.renderStars(i,e.rating),r.createSpan({text:e.rating.toFixed(1),cls:"card-viewer-rating-text"})}}renderStars(s,e){let t=e/2;for(let r=0;r<5;r++){let i=r<Math.floor(t),a=r===Math.floor(t)&&t%1>=.5,n=s.createEl("span",{cls:`card-viewer-star ${i?"full":a?"half":"empty"}`});a?n.innerHTML=`<svg viewBox="0 0 20 20" fill="none"><defs><clipPath id="half-star-${r}"><rect x="0" y="0" width="10" height="20"/></clipPath></defs><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" fill="#d1d5db"/><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" fill="#fbbf24" clip-path="url(#half-star-${r})"/></svg>`:n.innerHTML='<svg viewBox="0 0 20 20" fill="none"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>'}}renderDetails(s,e){let t=s.createEl("div",{cls:"card-viewer-details"});if(this.addDetail(t,"\u65E5\u671F",e.release_date),e.type==="music"){if(this.addDetail(t,"\u4F5C\u8005",e.author),this.addDetail(t,"\u4E13\u8F91",e.album),e.duration){let r=Math.floor(e.duration/60),i=e.duration%60;this.addDetail(t,"\u65F6\u957F",`${r}:${i.toString().padStart(2,"0")}`)}}else e.type==="book"?this.addDetail(t,"\u4F5C\u8005",e.author):(this.addDetail(t,"\u5730\u533A",e.region),e.runtime&&this.addDetail(t,"\u65F6\u957F",`${e.runtime}\u5206\u949F`))}renderPoster(s,e){if(e.poster){let t=e.poster;if(t.startsWith("attachment/")&&this.app.vault.getAbstractFileByPath(t))try{t=this.app.vault.adapter.getResourcePath(t)}catch(n){}let r=s.createEl("div",{cls:"card-viewer-poster-container"}),i=r.createEl("img",{cls:"card-viewer-poster card-viewer-poster-image",attr:{src:t,alt:e.title||"\u6D77\u62A5\u56FE\u7247"}});i.onerror=()=>{i.addClass("card-viewer-poster-image hidden");let a=r.createEl("div",{cls:"card-viewer-poster-error"});a.createEl("div",{text:"\u{1F4F7}",cls:"card-viewer-error-icon"}),a.createEl("div",{text:"\u56FE\u7247\u52A0\u8F7D\u5931\u8D25",cls:"card-viewer-error-text"})},i.onload=()=>{i.addClass("loaded")}}else{let t=s.createEl("div",{cls:"card-viewer-poster-placeholder",text:"\u6682\u65E0\u56FE\u7247"})}}renderAdditionalInfo(s,e){let t=s.querySelector(".card-viewer-details");if(t&&(this.addDetail(t,"\u7C7B\u578B",e.genres,"genres"),e.overview)){let i=t.createEl("div",{cls:"card-viewer-overview"}).createEl("div",{text:e.overview,cls:"card-viewer-overview-text"})}}addDetail(s,e,t,r=""){if(t){let i=s.createEl("div",{cls:`card-viewer-detail ${r}`});if(i.createEl("span",{text:`${e}: `,cls:"card-viewer-label"}),r==="genres"){let a=i.createEl("div",{cls:"card-viewer-genres-container"});t.toString().split(",").map(l=>l.trim()).forEach(l=>{l&&a.createEl("span",{text:l,cls:"card-viewer-genre-tag"})})}else i.createSpan({text:t.toString(),cls:"card-viewer-value"})}}},b=o=>new f(o);var w=class{constructor(s){this.app=s}async renderImgsGrid(s,e,t){try{let r=e.appendChild(document.createElement("div"));r.className="imgs-grid-header";let i=r.appendChild(document.createElement("span"));i.textContent="IMAGES",i.className="imgs-grid-type";let a=e.appendChild(document.createElement("div"));a.className="imgs-grid";let n=this.parseImages(s);n.length===0?this.renderEmptyPlaceholder(a):this.renderImages(a,n)}catch(r){let i=e.appendChild(document.createElement("div"));i.textContent=`\u56FE\u7247\u7F51\u683C\u6E32\u67D3\u5931\u8D25: ${r.message}`}}parseImages(s){let e=/!\[([^\]]*)\]\(([^\s\)]+)(?:\s+"([^"]+)")?\)/g,t=[],r;for(;(r=e.exec(s))!==null;)t.push({alt:r[1]||"",src:r[2],title:r[3]||""});return t}renderEmptyPlaceholder(s){let e=s.appendChild(document.createElement("div"));e.className="imgs-grid-placeholder",e.textContent="\u672A\u627E\u5230\u56FE\u7247"}renderImages(s,e){e.forEach((t,r)=>{let i=this.createImageItem(t,r);s.appendChild(i)})}createImageItem(s,e){let t=document.createElement("div");t.className="imgs-grid-item";let r=this.processImageSrc(s.src),i=this.createImageElement(t,r,s);return s.title&&this.addImageTitle(t,s.title),this.setupErrorHandling(i,t),this.setupClickHandler(i,r,s),t}processImageSrc(s){let e=s;try{e=decodeURIComponent(e)}catch(t){}if(e.startsWith("../")&&(e=e.replace(/^\.\.\//,""),this.app.vault.getAbstractFileByPath(e)))try{e=this.app.vault.adapter.getResourcePath(e)}catch(r){}return e}createImageElement(s,e,t){let r=s.appendChild(document.createElement("img"));return r.className="imgs-grid-image",r.src=e,r.alt=t.alt,r.loading="lazy",r}addImageTitle(s,e){let t=s.appendChild(document.createElement("div"));t.className="imgs-grid-title",t.textContent=e}setupErrorHandling(s,e){s.onerror=()=>{e.classList.add("error");let t=e.appendChild(document.createElement("div"));t.className="imgs-grid-error",t.textContent="\u56FE\u7247\u52A0\u8F7D\u5931\u8D25"}}setupClickHandler(s,e,t){s.addEventListener("click",()=>{this.showImageModal(e,t)})}showImageModal(s,e){let t=document.createElement("div");t.className="imgs-modal",t.innerHTML=`
      <div class="imgs-modal-content">
        <button class="imgs-modal-close" type="button" aria-label="\u5173\u95ED">&times;</button>
        <img src="${s}" alt="${e.alt}" class="imgs-modal-image">
        ${e.title?`<div class="imgs-modal-title">${e.title}</div>`:""}
      </div>
    `,document.body.appendChild(t);let r=()=>{document.body.removeChild(t)},i=t.querySelector(".imgs-modal-close");i&&i.addEventListener("click",r),t.addEventListener("click",a=>{a.target===t&&r()})}},P=o=>new w(o);var d=require("obsidian"),y=class extends d.Modal{constructor(e,t,r,i,a,n){super(e);this.title=t,this.message=r,this.confirmText=i,this.cancelText=a,this.resolve=n}onOpen(){let{contentEl:e,titleEl:t}=this;t.setText(this.title),e.empty();let r=e.createEl("p");r.style.marginBottom="20px",r.style.lineHeight="1.5",r.setText(this.message);let i=e.createEl("div");i.style.display="flex",i.style.justifyContent="flex-end",i.style.gap="10px";let a=i.createEl("button");a.setText(this.cancelText),a.onclick=()=>{this.close(),this.resolve(!1)};let n=i.createEl("button");n.setText(this.confirmText),n.addClass("mod-cta"),n.onclick=()=>{this.close(),this.resolve(!0)}}onClose(){let{contentEl:e}=this;e.empty()}},g=class extends d.PluginSettingTab{constructor(e,t){super(e,t);this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Card Viewer \u8BBE\u7F6E"}),new d.Setting(e).setName("\u542F\u7528 HTML \u89E3\u6790").setDesc("\u662F\u5426\u542F\u7528 HTML \u4EE3\u7801\u5757\u7684\u89E3\u6790\u548C\u6E32\u67D3\u529F\u80FD").addToggle(t=>t.setValue(this.plugin.settings.enableHtmlParsing).onChange(async r=>{if(!r&&this.plugin.settings.enableHtmlParsing)if(await this.showConfirmDialog("\u786E\u8BA4\u7981\u7528 HTML \u89E3\u6790",`\u7981\u7528 HTML \u89E3\u6790\u529F\u80FD\u9700\u8981\u91CD\u542F\u63D2\u4EF6\u624D\u80FD\u5B8C\u5168\u751F\u6548\u3002

\u662F\u5426\u786E\u8BA4\u7981\u7528\u5E76\u7ACB\u5373\u91CD\u542F\u63D2\u4EF6\uFF1F`,"\u786E\u8BA4\u5E76\u91CD\u542F","\u53D6\u6D88"))this.plugin.settings.enableHtmlParsing=r,await this.plugin.saveSettings(),new d.Notice("HTML\u89E3\u6790\u5DF2\u7981\u7528\uFF0C\u6B63\u5728\u91CD\u542F\u63D2\u4EF6..."),await this.restartPlugin();else{t.setValue(!0);return}else this.plugin.settings.enableHtmlParsing=r,await this.plugin.saveSettings(),this.plugin.updateHtmlProcessor(),r&&new d.Notice("HTML\u89E3\u6790\u5DF2\u542F\u7528")}))}async showConfirmDialog(e,t,r,i){return new Promise(a=>{new y(this.app,e,t,r,i,a).open()})}async restartPlugin(){let e=this.plugin.manifest.id,t=this.app.plugins;try{await t.disablePlugin(e),await new Promise(r=>setTimeout(r,100)),await t.enablePlugin(e),setTimeout(()=>{try{t.plugins[e]?(this.app.setting.open(),this.app.setting.openTabById(e),new d.Notice("\u63D2\u4EF6\u91CD\u542F\u5B8C\u6210\uFF0C\u8BBE\u7F6E\u9875\u9762\u5DF2\u91CD\u65B0\u6253\u5F00")):new d.Notice("\u63D2\u4EF6\u91CD\u542F\u5B8C\u6210")}catch(r){console.error("Failed to reopen settings:",r),new d.Notice("\u63D2\u4EF6\u91CD\u542F\u5B8C\u6210")}},200)}catch(r){new d.Notice("\u63D2\u4EF6\u91CD\u542F\u5931\u8D25\uFF0C\u8BF7\u624B\u52A8\u91CD\u542F"),console.error("Plugin restart failed:",r)}}};var h=class extends M.Plugin{constructor(e,t){super(e,t);this.registeredEvents=[];this.htmlProcessorRegistered=!1;this.settings=u;this.registeredEvents=[],this.errorHandler=H()}async onload(){await this.loadSettings(),!(!this.app||!this.app.workspace)&&typeof this.registerMarkdownCodeBlockProcessor=="function"&&(this.cardRenderer=b(this.app),this.imgsRenderer=P(this.app),this.addSettingTab(new g(this.app,this)),await p(()=>this.registerCardProcessors(),this.errorHandler,"registerCardProcessors"),await p(()=>this.registerHtmlProcessor(),this.errorHandler,"registerHtmlProcessor"),await p(()=>this.registerPostProcessor(),this.errorHandler,"registerPostProcessor"))}onunload(){try{this.htmlProcessorRegistered=!1,this.registeredEvents&&(this.registeredEvents.forEach(e=>{try{e.detach()}catch(t){}}),this.registeredEvents=[])}catch(e){}}registerCardProcessors(){["movie","tv","book","music"].forEach(t=>{this.registerMarkdownCodeBlockProcessor(`card-${t}`,async(r,i,a)=>{try{await this.cardRenderer.renderCard(t,r,i,a)}catch(n){i&&typeof i.createEl=="function"&&i.createEl("div",{text:`\u6E32\u67D3${t}\u5361\u7247\u5931\u8D25: ${n.message}`})}})})}registerHtmlProcessor(){this.settings.enableHtmlParsing&&!this.htmlProcessorRegistered&&(this.registerMarkdownCodeBlockProcessor("html",(e,t,r)=>{try{this.renderHtmlBlock(e,t)}catch(i){t.createEl("div",{text:`HTML\u6E32\u67D3\u5931\u8D25: ${i.message}`})}}),this.htmlProcessorRegistered=!0)}updateHtmlProcessor(){this.settings.enableHtmlParsing&&!this.htmlProcessorRegistered&&this.registerHtmlProcessor(),this.app.workspace&&this.app.workspace.trigger("layout-change")}renderHtmlBlock(e,t){let r=t.createEl("div",{cls:"html-viewer-container"});r.createEl("div",{cls:"html-viewer-header"}).createEl("span",{text:"HTML",cls:"html-viewer-type"});let a=r.createEl("div",{cls:"html-viewer-content"}),n=e.trim();this.isEmptyHtmlContent(n)?a.createEl("div",{cls:"html-viewer-placeholder",text:"\u7A7A\u7684HTML\u5185\u5BB9"}):a.innerHTML=e}isEmptyHtmlContent(e){return e.length===0||/^\s*<\w+(?:\s+(?!style|class|id)[^=]*(?:="[^"]*")?)*>\s*<\/\w+>\s*$/.test(e)&&!/\b(?:style|class|id)\s*=/.test(e)||/^\s*<\w+(?:\s+(?!style|class|id)[^=]*(?:="[^"]*")?)*\/>\s*$/.test(e)&&!/\b(?:style|class|id)\s*=/.test(e)}registerPostProcessor(){this.registerMarkdownPostProcessor(async(e,t)=>{try{await this.processCardBlocks(e,t),await this.processImgsBlocks(e,t)}catch(r){}})}async processCardBlocks(e,t){let r=e.querySelectorAll('pre > code[class*="language-card"]');for(let i=0;i<r.length;i++){let a=r[i],n=a.textContent||"",l=a.parentElement,c=null,m=a.className,C=m.match(/language-card-([a-z]+)/);if(C)c=C[1];else if(m.includes("language-card"))continue;let x=document.createElement("div");await this.cardRenderer.renderCard(c,n,x,t),l&&l.parentNode&&l.parentNode.replaceChild(x,l)}}async processImgsBlocks(e,t){let r=e.querySelectorAll('pre > code[class*="language-imgs"]');for(let i=0;i<r.length;i++){let a=r[i],n=a.textContent||"",l=a.parentElement,c=document.createElement("div");c.className="imgs-grid-container",await this.imgsRenderer.renderImgsGrid(n,c,t),l&&l.parentNode&&l.parentNode.replaceChild(c,l)}}async loadSettings(){this.settings=Object.assign({},u,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}};
