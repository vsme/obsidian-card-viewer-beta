/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var u=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var $=Object.getOwnPropertyNames;var B=Object.prototype.hasOwnProperty;var N=(o,r)=>{for(var e in r)u(o,e,{get:r[e],enumerable:!0})},V=(o,r,e,t)=>{if(r&&typeof r=="object"||typeof r=="function")for(let s of $(r))!B.call(o,s)&&s!==e&&u(o,s,{get:()=>r[s],enumerable:!(t=A(r,s))||t.enumerable});return o};var F=o=>V(u({},"__esModule",{value:!0}),o);var _={};N(_,{default:()=>v});module.exports=F(_);var S=require("obsidian");var g={enableHtmlParsing:!0};var T=()=>(o,r="unknown")=>{console.debug(`[CardViewer] Error in ${r}:`,o.message)},y=async(o,r,e="unknown")=>{try{return await o()}catch(t){return r(t,e),null}};var I=require("obsidian");var E=class{parseCard(r,e){let t=i=>{let n=e.split(`
`);for(let l of n){let d=l.match(new RegExp(`^${i}:\\s*(.*)$`));if(d){let H=d[1].trim();return H.length>0?H:void 0}}},s=i=>{let n=t(i);return n?parseFloat(n):void 0},a=t("title");return{type:r||"unknown",title:a||"\u672A\u547D\u540D",id:t("id")||s("id"),release_date:t("release_date"),region:t("region"),rating:s("rating"),runtime:s("runtime"),genres:t("genres"),overview:t("overview"),poster:t("poster"),author:t("author"),album:t("album"),duration:s("duration"),url:t("url"),source:t("source"),external_url:t("external_url")}}},M=new E;var b=require("obsidian"),w=class{constructor(r){this.app=r}processImagePath(r){let e=r;try{e=decodeURIComponent(e)}catch(t){}if(e.startsWith("./")){let t=e.replace(/^\.\//,"");return this.getVaultResourcePath(t)||r}else if(e.startsWith("../")){let t=e.replace(/^\.\.\//,"");return this.getVaultResourcePath(t)||r}else if(e.startsWith("/")&&!e.startsWith("//")){let t=e.substring(1);return this.getVaultResourcePath(t)||r}else if(!e.startsWith("/")&&!e.startsWith("http://")&&!e.startsWith("https://")&&!e.startsWith("data:")&&!e.startsWith("blob:")&&!e.startsWith("file:"))return this.getVaultResourcePath(e)||r;return e}getVaultResourcePath(r){try{let e=this.app.vault.getAbstractFileByPath(r);if(e instanceof b.TFile)return this.app.vault.getResourcePath(e)}catch(e){console.warn(`Failed to get resource path for: ${r}`,e)}return null}};function m(o){return new w(o)}var P=class{constructor(r){this.app=r;this.imagePathProcessor=m(r)}async renderCard(r,e,t,s){if(!t||typeof t.createEl!="function")return;let a=M.parseCard(r,e);if(!a){t.createEl("div",{text:"Invalid card format"});return}let i=t.createEl("div",{cls:"card-viewer-card"}),n=i.createEl("div",{cls:"card-viewer-content"}),l=n.createEl("div",{cls:"card-viewer-poster-section"}),d=n.createEl("div",{cls:"card-viewer-info-section"});this.addCardClickHandler(i,a),this.renderCardHeader(d,a),this.renderRating(d,a),this.renderDetails(d,a),this.renderPoster(l,a),this.renderAdditionalInfo(d,a)}addCardClickHandler(r,e){(e.id||e.type==="music"&&e.url||e.external_url)&&(r.addClass("card-viewer-clickable"),r.addEventListener("click",t=>{if(t.preventDefault(),e.external_url){window.open(e.external_url,"_blank");return}if(e.type==="music"&&e.url)window.open(e.url,"_blank");else if(e.id){let s=this.getBaseUrl(e);window.open(`${s}${e.id}`,"_blank")}}))}getBaseUrl(r){return r.source==="douban"?r.type==="movie"||r.type==="tv"?"https://movie.douban.com/subject/":r.type==="book"?"https://book.douban.com/subject/":"https://movie.douban.com/subject/":r.type==="tv"?"https://www.themoviedb.org/tv/":r.type==="book"?"https://book.douban.com/subject/":"https://www.themoviedb.org/movie/"}renderCardHeader(r,e){let t=r.createEl("div",{cls:"card-viewer-header"}),s=t.createEl("h3",{text:e.title,cls:"card-viewer-title"});t.createEl("div",{cls:"card-viewer-header-right"}).createEl("span",{text:e.type.toUpperCase(),cls:`card-viewer-type card-viewer-type-${e.type}`})}renderRating(r,e){if(e.rating){let s=r.createEl("div",{cls:"card-viewer-meta"}).createEl("div",{cls:"card-viewer-rating"}),a=s.createEl("div",{cls:"card-viewer-stars"});this.renderStars(a,e.rating),s.createSpan({text:e.rating.toFixed(1),cls:"card-viewer-rating-text"})}}renderStars(r,e){let t=e/2;for(let s=0;s<5;s++){let a=s<Math.floor(t),i=r.createEl("span",{cls:`card-viewer-star ${a?"full":"empty"}`});(0,I.setIcon)(i,"star")}}renderDetails(r,e){let t=r.createEl("div",{cls:"card-viewer-details"});if(this.addDetail(t,"\u65E5\u671F",e.release_date),e.type==="music"){if(this.addDetail(t,"\u4F5C\u8005",e.author),this.addDetail(t,"\u4E13\u8F91",e.album),e.duration){let s=Math.floor(e.duration/60),a=e.duration%60;this.addDetail(t,"\u65F6\u957F",`${s}:${a.toString().padStart(2,"0")}`)}}else e.type==="book"?this.addDetail(t,"\u4F5C\u8005",e.author):(this.addDetail(t,"\u5730\u533A",e.region),e.runtime&&this.addDetail(t,"\u65F6\u957F",`${e.runtime}\u5206\u949F`))}renderPoster(r,e){if(e.poster){let t=this.imagePathProcessor.processImagePath(e.poster),s=r.createEl("div",{cls:"card-viewer-poster-container"}),a=s.createEl("img",{cls:"card-viewer-poster card-viewer-poster-image",attr:{src:t,alt:e.title||"\u6D77\u62A5\u56FE\u7247"}});a.onerror=()=>{a.addClass("card-viewer-poster-image hidden");let i=s.createEl("div",{cls:"card-viewer-poster-error"});i.createEl("div",{text:"\u{1F4F7}",cls:"card-viewer-error-icon"}),i.createEl("div",{text:"\u56FE\u7247\u52A0\u8F7D\u5931\u8D25",cls:"card-viewer-error-text"})},a.onload=()=>{a.addClass("loaded")}}else{let t=r.createEl("div",{cls:"card-viewer-poster-placeholder",text:"\u6682\u65E0\u56FE\u7247"})}}renderAdditionalInfo(r,e){let t=r.querySelector(".card-viewer-details");if(t&&(this.addDetail(t,"\u7C7B\u578B",e.genres,"genres"),e.overview)){let a=t.createEl("div",{cls:"card-viewer-overview"}).createEl("div",{text:e.overview,cls:"card-viewer-overview-text"})}}addDetail(r,e,t,s=""){if(t){let a=r.createEl("div",{cls:`card-viewer-detail ${s}`});if(a.createEl("span",{text:`${e}: `,cls:"card-viewer-label"}),s==="genres"){let i=a.createEl("div",{cls:"card-viewer-genres-container"});t.toString().split(/[,ï¼Œ]/).map(l=>l.trim()).filter(l=>l).forEach(l=>{l&&i.createEl("span",{text:l,cls:"card-viewer-genre-tag"})})}else a.createSpan({text:t.toString(),cls:"card-viewer-value"})}}},L=o=>new P(o);var k=require("obsidian"),h=class extends k.Modal{constructor(e,t,s){super(e);this.imageSrc=t,this.imageData=s}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("card-viewer-image-modal"),e.createEl("button",{cls:"card-viewer-modal-close",text:"\xD7"}).addEventListener("click",()=>{this.close()});let s=e.createEl("img",{cls:"card-viewer-modal-image",attr:{src:this.imageSrc,alt:this.imageData.alt||"Image"}});this.imageData.title&&e.createEl("div",{cls:"card-viewer-modal-title",text:this.imageData.title}),s.addEventListener("error",()=>{s.addClass("card-viewer-modal-image-hidden"),e.createEl("div",{cls:"card-viewer-modal-error",text:"Failed to load image"})})}onClose(){let{contentEl:e}=this;e.empty()}};var f=class{constructor(r){this.app=r;this.imagePathProcessor=m(r)}async renderImgsGrid(r,e,t){try{let s=e.appendChild(document.createElement("div"));s.className="card-viewer-imgs-header";let a=s.appendChild(document.createElement("span"));a.textContent="IMAGES",a.className="card-viewer-imgs-type";let i=e.appendChild(document.createElement("div"));i.className="card-viewer-imgs-grid";let n=this.parseImages(r);n.length===0?this.renderEmptyPlaceholder(i):this.renderImages(i,n)}catch(s){let a=e.appendChild(document.createElement("div"));a.textContent=`\u56FE\u7247\u7F51\u683C\u6E32\u67D3\u5931\u8D25: ${s.message}`}}parseImages(r){let e=/!\[([^\]]*)\]\(([^\s\)]+)(?:\s+"([^"]+)")?\)/g,t=[],s;for(;(s=e.exec(r))!==null;)t.push({alt:s[1]||"",src:s[2],title:s[3]||""});return t}renderEmptyPlaceholder(r){let e=r.appendChild(document.createElement("div"));e.className="card-viewer-imgs-placeholder",e.textContent="\u672A\u627E\u5230\u56FE\u7247"}renderImages(r,e){e.forEach((t,s)=>{let a=this.createImageItem(t,s);r.appendChild(a)})}createImageItem(r,e){let t=document.createElement("div");t.className="card-viewer-imgs-item";let s=this.processImageSrc(r.src),a=this.createImageElement(t,s,r);return r.title&&this.addImageTitle(t,r.title),this.setupErrorHandling(a,t),this.setupClickHandler(a,s,r),t}processImageSrc(r){return this.imagePathProcessor.processImagePath(r)}createImageElement(r,e,t){let s=r.appendChild(document.createElement("img"));return s.className="card-viewer-imgs-image",s.src=e,s.alt=t.alt,s.loading="lazy",s}addImageTitle(r,e){let t=r.appendChild(document.createElement("div"));t.className="card-viewer-imgs-title",t.textContent=e}setupErrorHandling(r,e){r.onerror=()=>{e.classList.add("error");let t=e.appendChild(document.createElement("div"));t.className="card-viewer-imgs-error",t.textContent="\u56FE\u7247\u52A0\u8F7D\u5931\u8D25"}}setupClickHandler(r,e,t){r.addEventListener("click",()=>{this.showImageModal(e,t)})}showImageModal(r,e){new h(this.app,r,e).open()}},R=o=>new f(o);var C=class{constructor(r){this.app=r;this.imagePathProcessor=m(r)}async renderHtml(r,e){try{r.empty(),r.addClass("card-viewer-html-content");let t=this.preprocessHtmlContent(e),a=new DOMParser().parseFromString(t,"text/html"),i=Array.from(a.body.children);for(let n of i)r.appendChild(n.cloneNode(!0));await this.postProcessHtmlElements(r)}catch(t){console.error("HTML\u6E32\u67D3\u5931\u8D25:",t);let s=t instanceof Error?t.message:String(t);this.showError(r,`HTML\u6E32\u67D3\u5931\u8D25: ${s}`)}}preprocessHtmlContent(r){let e=/\.(jpg|jpeg|png|gif|bmp|webp|svg|mp4|webm|ogg|avi|mov|wmv|flv|mkv|m4v|3gp|mp3|wav|aac|flac|m4a)$/i;return r=r.replace(/(src|poster)=(["'])([^"']*?)\2/gi,(t,s,a,i)=>{if(e.test(i)){let n=this.imagePathProcessor.processImagePath(i);return`${s}=${a}${n}${a}`}return t}),r}async postProcessHtmlElements(r){r.querySelectorAll("img").forEach(t=>{t.addEventListener("error",()=>{this.showImageError(t,"\u56FE\u7247\u52A0\u8F7D\u5931\u8D25")}),t.addEventListener("load",()=>{t.setAttribute("data-loaded","true")})})}showError(r,e){r.empty();let t=r.createEl("div",{cls:"card-viewer-html-error",text:e})}showImageError(r,e){let t=document.createElement("div");t.className="card-viewer-image-load-error",t.textContent=e,r.parentNode&&r.parentNode.insertBefore(t,r.nextSibling)}};function D(o){return new C(o)}var c=require("obsidian"),x=class extends c.Modal{constructor(e,t,s,a,i,n){super(e);this.title=t,this.message=s,this.confirmText=a,this.cancelText=i,this.resolve=n}onOpen(){let{contentEl:e,titleEl:t}=this;t.setText(this.title),e.empty(),e.createEl("p",{cls:"card-viewer-settings-message"}).setText(this.message);let a=e.createEl("div",{cls:"card-viewer-settings-button-container"}),i=a.createEl("button");i.setText(this.cancelText),i.onclick=()=>{this.close(),this.resolve(!1)};let n=a.createEl("button");n.setText(this.confirmText),n.addClass("mod-cta"),n.onclick=()=>{this.close(),this.resolve(!0)}}onClose(){let{contentEl:e}=this;e.empty()}},p=class extends c.PluginSettingTab{constructor(e,t){super(e,t);this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Card Viewer \u8BBE\u7F6E"}),new c.Setting(e).setName("\u542F\u7528 HTML \u89E3\u6790").setDesc("\u662F\u5426\u542F\u7528 HTML \u4EE3\u7801\u5757\u7684\u89E3\u6790\u548C\u6E32\u67D3\u529F\u80FD").addToggle(t=>t.setValue(this.plugin.settings.enableHtmlParsing).onChange(async s=>{if(!s&&this.plugin.settings.enableHtmlParsing)if(await this.showConfirmDialog("\u786E\u8BA4\u7981\u7528 HTML \u89E3\u6790",`\u7981\u7528 HTML \u89E3\u6790\u529F\u80FD\u9700\u8981\u91CD\u542F\u63D2\u4EF6\u624D\u80FD\u5B8C\u5168\u751F\u6548\u3002

\u662F\u5426\u786E\u8BA4\u7981\u7528\u5E76\u7ACB\u5373\u91CD\u542F\u63D2\u4EF6\uFF1F`,"\u786E\u8BA4\u5E76\u91CD\u542F","\u53D6\u6D88"))this.plugin.settings.enableHtmlParsing=s,await this.plugin.saveSettings(),new c.Notice("HTML\u89E3\u6790\u5DF2\u7981\u7528\uFF0C\u6B63\u5728\u91CD\u542F\u63D2\u4EF6..."),await this.restartPlugin();else{t.setValue(!0);return}else this.plugin.settings.enableHtmlParsing=s,await this.plugin.saveSettings(),this.plugin.updateHtmlProcessor(),s&&new c.Notice("HTML\u89E3\u6790\u5DF2\u542F\u7528")}))}async showConfirmDialog(e,t,s,a){return new Promise(i=>{new x(this.app,e,t,s,a,i).open()})}async restartPlugin(){let e=this.plugin.manifest.id,t=this.app.plugins;try{await t.disablePlugin(e),await new Promise(s=>setTimeout(s,100)),await t.enablePlugin(e),setTimeout(()=>{try{t.plugins[e]?(this.app.setting.open(),this.app.setting.openTabById(e),new c.Notice("\u63D2\u4EF6\u91CD\u542F\u5B8C\u6210\uFF0C\u8BBE\u7F6E\u9875\u9762\u5DF2\u91CD\u65B0\u6253\u5F00")):new c.Notice("\u63D2\u4EF6\u91CD\u542F\u5B8C\u6210")}catch(s){console.error("Failed to reopen settings:",s),new c.Notice("\u63D2\u4EF6\u91CD\u542F\u5B8C\u6210")}},200)}catch(s){new c.Notice("\u63D2\u4EF6\u91CD\u542F\u5931\u8D25\uFF0C\u8BF7\u624B\u52A8\u91CD\u542F"),console.error("Plugin restart failed:",s)}}};var v=class extends S.Plugin{constructor(e,t){super(e,t);this.htmlProcessorRegistered=!1;this.settings=g;this.errorHandler=T()}async onload(){try{await this.loadSettings(),this.initializeRenderers(),this.setupUserInterface(),await this.registerAllProcessors()}catch(e){this.errorHandler(e,"onload")}}onunload(){this.htmlProcessorRegistered=!1}initializeRenderers(){this.cardRenderer=L(this.app),this.imgsRenderer=R(this.app),this.htmlRenderer=D(this.app)}setupUserInterface(){this.addSettingTab(new p(this.app,this))}async registerAllProcessors(){let e=[{name:"Card Processors",fn:()=>this.registerCardProcessors()},{name:"HTML Processor",fn:()=>this.registerHtmlProcessor()},{name:"Post Processor",fn:()=>this.registerPostProcessor()}];for(let t of e)await y(t.fn,this.errorHandler,t.name)}registerCardProcessors(){["movie","tv","book","music"].forEach(t=>{this.registerMarkdownCodeBlockProcessor(`card-${t}`,this.createCardProcessor(t))})}createCardProcessor(e){return async(t,s,a)=>{try{await this.cardRenderer.renderCard(e,t,s,a)}catch(i){this.renderError(s,`\u6E32\u67D3${e}\u5361\u7247\u5931\u8D25`,i instanceof Error?i:new Error(String(i)))}}}registerHtmlProcessor(){this.settings.enableHtmlParsing&&!this.htmlProcessorRegistered&&(this.registerMarkdownCodeBlockProcessor("html",this.createHtmlProcessor()),this.htmlProcessorRegistered=!0)}createHtmlProcessor(){return(e,t,s)=>{try{this.renderHtmlBlock(e,t)}catch(a){this.renderError(t,"HTML\u6E32\u67D3\u5931\u8D25",a instanceof Error?a:new Error(String(a)))}}}updateHtmlProcessor(){var e;this.settings.enableHtmlParsing&&!this.htmlProcessorRegistered&&this.registerHtmlProcessor(),(e=this.app.workspace)==null||e.trigger("layout-change")}renderHtmlBlock(e,t){let s=e.trim(),a=this.createHtmlContainer(t),i=this.createContentArea(a);this.isEmptyHtmlContent(s)?this.renderEmptyContent(i):this.htmlRenderer.renderHtml(i,s)}createHtmlContainer(e){let t=e.createEl("div",{cls:"card-viewer-html-container"}),a=t.createEl("div",{cls:"card-viewer-html-header"}).createEl("span",{cls:"card-viewer-html-type",text:"HTML"});return t}createContentArea(e){return e.createEl("div",{cls:"card-viewer-html-content"})}renderEmptyContent(e){e.createEl("div",{cls:"html-viewer-placeholder",text:"\u7A7A\u7684HTML\u5185\u5BB9"})}isEmptyHtmlContent(e){if(e.length===0)return!0;let t="img|video|audio|source|track|embed|object|iframe|canvas|svg|picture";return[new RegExp(`^\\s*<(?!(${t})\\b)\\w+(?:\\s+(?!style|class|id)[^=]*(?:="[^"]*")?)*>\\s*</(?!(${t})\\b)\\w+>\\s*$`,"i"),new RegExp(`^\\s*<(?!(${t})\\b)\\w+(?:\\s+(?!style|class|id)[^=]*(?:="[^"]*")?)*\\/>\\s*$`,"i")].some(a=>a.test(e)&&!/\b(?:style|class|id)\s*=/.test(e))}registerPostProcessor(){this.registerMarkdownPostProcessor(async(e,t)=>{try{await Promise.all([this.processCardBlocks(e,t),this.processImgsBlocks(e,t)])}catch(s){console.warn("CardViewer: Post processor error:",s)}})}async processCardBlocks(e,t){let s=e.querySelectorAll('pre > code[class*="language-card"]');for(let a of Array.from(s)){let i=a,n=this.extractCardType(i.className);n&&await this.processCardBlock(i,n,t)}}extractCardType(e){let t=e.match(/language-card-([a-z]+)/);return t?t[1]:null}async processCardBlock(e,t,s){let a=e.textContent||"",i=e.parentElement;if(!(i!=null&&i.parentNode))return;let n=document.createElement("div");await this.cardRenderer.renderCard(t,a,n,s),i.parentNode.replaceChild(n,i)}async processImgsBlocks(e,t){let s=e.querySelectorAll('pre > code[class*="language-imgs"]');for(let a of Array.from(s))await this.processImgsBlock(a,t)}async processImgsBlock(e,t){let s=e.textContent||"",a=e.parentElement;if(!(a!=null&&a.parentNode))return;let i=document.createElement("div");i.className="card-viewer-imgs-grid-container",await this.imgsRenderer.renderImgsGrid(s,i,t),a.parentNode.replaceChild(i,a)}renderError(e,t,s){e&&typeof e.createEl=="function"&&e.createEl("div",{text:`${t}: ${s.message}`,cls:"card-viewer-error"})}async loadSettings(){try{let e=await this.loadData();this.settings=Object.assign({},g,e)}catch(e){console.warn("CardViewer: Failed to load settings:",e),this.settings={...g}}}async saveSettings(){try{await this.saveData(this.settings)}catch(e){throw console.error("CardViewer: Failed to save settings:",e),e}}};
